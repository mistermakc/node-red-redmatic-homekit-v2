{"version":3,"file":"flight2.js","sourceRoot":"","sources":["../../../../../../dtls/src/flight/server/flight2.ts"],"names":[],"mappings":"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","sourcesContent":["import { randomBytes } from \"crypto\";\nimport debug from \"debug\";\n\nimport {\n  CipherSuite,\n  NamedCurveAlgorithmList,\n  NamedCurveAlgorithms,\n  SignatureAlgorithm,\n} from \"../../cipher/const\";\nimport { generateKeyPair } from \"../../cipher/namedCurve\";\nimport { CipherContext } from \"../../context/cipher\";\nimport { DtlsContext } from \"../../context/dtls\";\nimport { Profile, SrtpContext } from \"../../context/srtp\";\nimport { TransportContext } from \"../../context/transport\";\nimport { EllipticCurves } from \"../../handshake/extensions/ellipticCurves\";\nimport { ExtendedMasterSecret } from \"../../handshake/extensions/extendedMasterSecret\";\nimport { RenegotiationIndication } from \"../../handshake/extensions/renegotiationIndication\";\nimport { Signature } from \"../../handshake/extensions/signature\";\nimport { UseSRTP } from \"../../handshake/extensions/useSrtp\";\nimport { ClientHello } from \"../../handshake/message/client/hello\";\nimport { ServerHelloVerifyRequest } from \"../../handshake/message/server/helloVerifyRequest\";\nimport { DtlsRandom } from \"../../handshake/random\";\nimport { createFragments, createPlaintext } from \"../../record/builder\";\nimport { ContentType } from \"../../record/const\";\n\nconst log = debug(\"werift-dtls : packages/dtls/flight/server/flight2.ts : log\");\n\n// HelloVerifyRequest do not retransmit\n\nexport const flight2 =\n  (\n    udp: TransportContext,\n    dtls: DtlsContext,\n    cipher: CipherContext,\n    srtp: SrtpContext,\n  ) =>\n  (clientHello: ClientHello) => {\n    log(\"dtls version\", clientHello.clientVersion);\n\n    dtls.flight = 2;\n\n    // if flight 2 restarts due to packet loss, sequence numbers are reused from the top:\n    // https://datatracker.ietf.org/doc/html/rfc6347#section-4.2.2\n    // The first message each side transmits in each handshake always has\n    // message_seq = 0.  Whenever each new message is generated, the\n    // message_seq value is incremented by one.  Note that in the case of a\n    // rehandshake, this implies that the HelloRequest will have message_seq = 0\n    // and the ServerHello will have message_seq = 1.  When a message is\n    // retransmitted, the same message_seq value is used.\n    dtls.recordSequenceNumber = 0;\n    dtls.sequenceNumber = 0;\n\n    clientHello.extensions.forEach((extension) => {\n      switch (extension.type) {\n        case EllipticCurves.type: {\n          const curves = EllipticCurves.fromData(extension.data).data;\n          log(dtls.sessionId, \"curves\", curves);\n          const curve = curves.filter((curve) =>\n            NamedCurveAlgorithmList.includes(curve as any),\n          )[0] as NamedCurveAlgorithms;\n          cipher.namedCurve = curve;\n          log(dtls.sessionId, \"curve selected\", cipher.namedCurve);\n        }\n        break;\n        case Signature.type: {\n          if (!cipher.signatureHashAlgorithm)\n            throw new Error(\"need to set certificate\");\n\n          const signatureHash = Signature.fromData(extension.data).data;\n          log(dtls.sessionId, \"hash,signature\", signatureHash);\n          const signature = signatureHash.find(\n            (v) => v.signature === cipher.signatureHashAlgorithm?.signature,\n          )?.signature;\n          const hash = signatureHash.find(\n            (v) => v.hash === cipher.signatureHashAlgorithm?.hash,\n          )?.hash;\n          if (signature == undefined || hash == undefined) {\n            throw new Error(\"invalid signatureHash\");\n          }\n        }\n        break;\n        case UseSRTP.type: {\n          if (!dtls.options?.srtpProfiles) return;\n          if (dtls.options.srtpProfiles.length === 0) return;\n\n          const useSrtp = UseSRTP.fromData(extension.data);\n          log(dtls.sessionId, \"srtp profiles\", useSrtp.profiles);\n          const profile = SrtpContext.findMatchingSRTPProfile(\n            useSrtp.profiles as Profile[],\n            dtls.options?.srtpProfiles,\n          );\n          if (!profile) {\n            throw new Error();\n          }\n          srtp.srtpProfile = profile;\n          log(dtls.sessionId, \"srtp profile selected\", srtp.srtpProfile);\n        }\n        break;\n        case ExtendedMasterSecret.type: {\n          dtls.remoteExtendedMasterSecret = true;\n        }\n        break;\n        case RenegotiationIndication.type: {\n          log(dtls.sessionId, \"RenegotiationIndication\", extension.data);\n        }\n        case 43: {\n          // todo dtls1.3\n          const data = extension.data.subarray(1);\n          const versions = [...data].map((v) => v.toString(10));\n          log(\"dtls supported version\", versions);\n        }\n        break;\n      }\n    });\n\n    cipher.localRandom = new DtlsRandom();\n    cipher.remoteRandom = DtlsRandom.from(clientHello.random);\n\n    const suites = clientHello.cipherSuites;\n    log(dtls.sessionId, \"cipher suites\", suites);\n    const suite = (() => {\n      switch (cipher.signatureHashAlgorithm?.signature) {\n        case SignatureAlgorithm.ecdsa_3:\n          return CipherSuite.TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256_49195;\n        case SignatureAlgorithm.rsa_1:\n          return CipherSuite.TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256_49199;\n      }\n    })();\n    if (suite === undefined || !suites.includes(suite)) {\n      throw new Error(\"dtls cipher suite negotiation failed\");\n    }\n    cipher.cipherSuite = suite;\n    log(dtls.sessionId, \"selected cipherSuite\", cipher.cipherSuite);\n\n    cipher.localKeyPair = generateKeyPair(cipher.namedCurve);\n\n    dtls.cookie ||= randomBytes(20);\n    const helloVerifyReq = new ServerHelloVerifyRequest(\n      {\n        major: 255 - 1,\n        minor: 255 - 2,\n      },\n      dtls.cookie,\n    );\n    const fragments = createFragments(dtls)([helloVerifyReq]);\n    const packets = createPlaintext(dtls)(\n      fragments.map((fragment) => ({\n        type: ContentType.handshake,\n        fragment: fragment.serialize(),\n      })),\n      ++dtls.recordSequenceNumber,\n    );\n\n    const chunk = packets.map((v) => v.serialize());\n    for (const buf of chunk) {\n      udp.send(buf);\n    }\n  };\n"]}