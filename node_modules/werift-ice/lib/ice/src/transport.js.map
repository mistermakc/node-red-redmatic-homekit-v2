{"version":3,"file":"transport.js","sourceRoot":"","sources":["../../../src/transport.ts"],"names":[],"mappings":"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","sourcesContent":["import { type Socket, type SocketType, createSocket } from \"dgram\";\nimport debug from \"debug\";\n\nimport { type Socket as TcpSocket, connect } from \"net\";\nimport {\n  type InterfaceAddresses,\n  findPort,\n  interfaceAddress,\n} from \"../../common/src\";\nimport type { Address } from \"./types/model\";\nimport { normalizeFamilyNodeV18 } from \"./utils\";\n\nconst log = debug(\"werift-ice:packages/ice/src/transport.ts\");\n\nexport class UdpTransport implements Transport {\n  readonly type = \"udp\";\n  readonly socket: Socket;\n  onData: (data: Buffer, addr: Address) => void = () => {};\n\n  private constructor(\n    private socketType: SocketType,\n    private portRange?: [number, number],\n    private interfaceAddresses?: InterfaceAddresses,\n  ) {\n    this.socket = createSocket(socketType);\n    this.socket.on(\"message\", (data, info) => {\n      if (normalizeFamilyNodeV18(info.family) === 6) {\n        [info.address] = info.address.split(\"%\"); // example fe80::1d3a:8751:4ffd:eb80%wlp82s0\n      }\n      try {\n        this.onData(data, [info.address, info.port]);\n      } catch (error) {\n        log(\"onData error\", error);\n      }\n    });\n  }\n\n  static async init(\n    type: SocketType,\n    portRange?: [number, number],\n    interfaceAddresses?: InterfaceAddresses,\n  ) {\n    const transport = new UdpTransport(type, portRange, interfaceAddresses);\n    await transport.init();\n    return transport;\n  }\n\n  private async init() {\n    const address = interfaceAddress(this.socketType, this.interfaceAddresses);\n    if (this.portRange) {\n      const port = await findPort(\n        this.portRange[0],\n        this.portRange[1],\n        this.socketType,\n        this.interfaceAddresses,\n      );\n      this.socket.bind({ port, address });\n    } else {\n      this.socket.bind({ address });\n    }\n    await new Promise((r) => this.socket.once(\"listening\", r));\n  }\n\n  send = (data: Buffer, addr: Address) =>\n    new Promise<void>((r, f) => {\n      this.socket.send(data, addr[1], addr[0], (error) => {\n        if (error) {\n          log(\"send error\", addr, data);\n          f(error);\n        } else {\n          r();\n        }\n      });\n    });\n\n  address() {\n    return this.socket.address();\n  }\n\n  close = () =>\n    new Promise<void>((r) => {\n      this.socket.once(\"close\", r);\n      try {\n        this.socket.close();\n      } catch (error) {\n        r();\n      }\n    });\n}\n\nexport class TcpTransport implements Transport {\n  readonly type = \"tcp\";\n  private connecting!: Promise<void>;\n  private client!: TcpSocket;\n  onData: (data: Buffer, addr: Address) => void = () => {};\n  closed = false;\n\n  private constructor(private addr: Address) {\n    this.connect();\n  }\n\n  private connect() {\n    if (this.closed) {\n      return;\n    }\n\n    if (this.client) {\n      this.client.destroy();\n    }\n    this.connecting = new Promise((r, f) => {\n      try {\n        this.client = connect({ port: this.addr[1], host: this.addr[0] }, r);\n      } catch (error) {\n        f(error);\n      }\n    });\n\n    this.client.on(\"data\", (data) => {\n      const addr = [\n        this.client.remoteAddress!,\n        this.client.remotePort!,\n      ] as Address;\n      this.onData(data, addr);\n    });\n    this.client.on(\"end\", () => {\n      this.connect();\n    });\n    this.client.on(\"error\", (error) => {\n      console.log(\"error\", error);\n    });\n  }\n\n  private async init() {\n    await this.connecting;\n  }\n\n  static async init(addr: Address) {\n    const transport = new TcpTransport(addr);\n    await transport.init();\n    return transport;\n  }\n\n  send = async (data: Buffer, addr: Address) => {\n    await this.connecting;\n    this.client.write(data, (err) => {\n      if (err) {\n        console.log(\"err\", err);\n      }\n    });\n  };\n\n  close = async () => {\n    this.closed = true;\n    this.client.destroy();\n  };\n}\n\nexport interface Transport {\n  type: string;\n  onData: (data: Buffer, addr: Address) => void;\n  send: (data: Buffer, addr: Address) => Promise<void>;\n  close: () => Promise<void>;\n}\n"]}